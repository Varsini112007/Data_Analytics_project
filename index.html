{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "e0da151e-8a77-491b-803a-ac59226e11d1",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "True"
      ]
     },
     "execution_count": 1,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#final DASHBOARD\n",
    "\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import plotly.express as px\n",
    "import plotly.io as pio\n",
    "import matplotlib.pyplot as plt\n",
    "import matplotlib.ticker as mtick\n",
    "import base64\n",
    "from io import BytesIO\n",
    "from datetime import datetime, time\n",
    "import pytz\n",
    "import os\n",
    "import webbrowser\n",
    "import logging\n",
    "\n",
    "# --- CONFIGURATION & UNICODE FONT FIX ---\n",
    "logging.getLogger('matplotlib.font_manager').setLevel(logging.ERROR)\n",
    "\n",
    "plt.rcParams['font.family'] = [\n",
    "    'Nirmala UI', 'MS Gothic', 'Segoe UI', 'Arial Unicode MS', \n",
    "    'SimSun', 'DejaVu Sans', 'sans-serif'\n",
    "]\n",
    "plt.rcParams['axes.unicode_minus'] = False \n",
    "\n",
    "ist = pytz.timezone('Asia/Kolkata')\n",
    "current_time_obj = datetime.now(ist)\n",
    "\n",
    "def fig_to_base64(fig):\n",
    "    if fig is None: return None\n",
    "    tmpfile = BytesIO()\n",
    "    fig.savefig(tmpfile, format='png', bbox_inches='tight', facecolor='#111111', dpi=150)\n",
    "    plt.close(fig)\n",
    "    return base64.b64encode(tmpfile.getvalue()).decode('utf-8')\n",
    "\n",
    "# --- DATA PREP ---\n",
    "Apps_Df = pd.read_csv(\"Play Store Data.csv\")\n",
    "Apps_Df['Installs'] = Apps_Df['Installs'].astype(str).str.replace(r'[+,]', '', regex=True)\n",
    "Apps_Df['Installs'] = pd.to_numeric(Apps_Df['Installs'], errors='coerce').fillna(0)\n",
    "Apps_Df['Rating'] = pd.to_numeric(Apps_Df['Rating'], errors='coerce')\n",
    "Apps_Df['Reviews'] = pd.to_numeric(Apps_Df['Reviews'], errors='coerce').fillna(0)\n",
    "Apps_Df['Last Updated'] = pd.to_datetime(Apps_Df['Last Updated'], errors='coerce')\n",
    "\n",
    "# --- TASK 1 COMPONENTS ---\n",
    "fig1 = None\n",
    "if 2 <= current_time_obj.hour < 20:\n",
    "    f_apps = Apps_Df[(Apps_Df['Rating'] >= 4) & (Apps_Df['Last Updated'].dt.month == 1)]\n",
    "    c_grp = f_apps.groupby('Category').agg({'Rating': 'mean', 'Reviews': 'sum'}).sort_values('Reviews', ascending=False).head(10)\n",
    "    fig1 = px.bar(c_grp.reset_index().melt(id_vars='Category', value_vars=['Rating', 'Reviews']),\n",
    "                 x='Category', y='value', color='variable', barmode='group',\n",
    "                 color_discrete_map={'Rating':'#38bdf8', 'Reviews':'#818cf8'}, template=\"plotly_dark\")\n",
    "    fig1.update_layout(margin=dict(t=10, b=80), paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)')\n",
    "\n",
    "PIE_CHART = px.pie(values=Apps_Df['Type'].value_counts().values, names=Apps_Df['Type'].value_counts().index, \n",
    "                   color_discrete_sequence=['#2dd4bf', '#2563eb'], template=\"plotly_dark\")\n",
    "PIE_CHART.update_layout(margin=dict(t=10, b=10), paper_bgcolor='rgba(0,0,0,0)')\n",
    "\n",
    "HISTOGRAM = px.histogram(Apps_Df, x='Rating', nbins=20, \n",
    "                         color_discrete_sequence=['#a855f7'], template=\"plotly_dark\")\n",
    "HISTOGRAM.update_layout(margin=dict(t=10, b=40), paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)')\n",
    "\n",
    "# --- OTHER TASKS LOGIC ---\n",
    "def run_t2():\n",
    "    if not (2 <= current_time_obj.hour < 20): return None\n",
    "    df = Apps_Df.copy()\n",
    "    raw_df = pd.read_csv(\"Play Store Data.csv\")\n",
    "    df['Price'] = pd.to_numeric(raw_df['Price'].astype(str).str.replace('$', '', regex=False), errors='coerce').fillna(0)\n",
    "    df['Revenue'] = df['Installs'] * df['Price']\n",
    "    top_cats = df['Category'].value_counts().head(3).index\n",
    "    res = df[df['Category'].isin(top_cats)].groupby(['Category', 'Type']).agg({'Installs': 'mean', 'Revenue': 'mean'}).reset_index()\n",
    "    fig, ax1 = plt.subplots(figsize=(10, 6), facecolor='#111111')\n",
    "    ax1.set_facecolor('#111111')\n",
    "    labels = [f\"{r['Category']}\\n({r['Type']})\" for _, r in res.iterrows()]\n",
    "    ax1.bar(np.arange(len(labels)), res['Installs'], 0.5, color='#66fcf1', alpha=0.8, label='Avg Installs')\n",
    "    ax2 = ax1.twinx()\n",
    "    ax2.plot(np.arange(len(labels)), res['Revenue'], color='#f0a500', marker='o', linewidth=3, label='Avg Revenue ($)')\n",
    "    ax1.set_xticks(np.arange(len(labels)))\n",
    "    ax1.set_xticklabels(labels, color='white', fontsize=9, fontweight='bold')\n",
    "    ax1.tick_params(colors='white'); ax2.tick_params(colors='white')\n",
    "    ax1.legend(loc='upper left', facecolor='#111111', labelcolor='white', frameon=False)\n",
    "    ax2.legend(loc='upper right', facecolor='#111111', labelcolor='white', frameon=False)\n",
    "    return fig\n",
    "\n",
    "def run_t3():\n",
    "    df = Apps_Df.copy()\n",
    "    df[\"Country\"] = np.random.choice([\"India\", \"United States\", \"United Kingdom\", \"Canada\", \"Germany\", \"France\", \"Brazil\", \"Australia\", \"Japan\", \"South Africa\"], size=len(df))\n",
    "    if not (time(0, 0) <= current_time_obj.time() <= time(20, 0)): return None\n",
    "    df_f = df[~df[\"Category\"].str.startswith((\"A\", \"C\", \"G\", \"S\"), na=False)]\n",
    "    top_cat = df_f.groupby(\"Category\")[\"Installs\"].sum().sort_values(ascending=False).head(5).index\n",
    "    df_map = df_f[df_f[\"Category\"].isin(top_cat)].groupby([\"Country\", \"Category\"], as_index=False).agg({\"Installs\": \"sum\"})\n",
    "    iso = {\"India\": \"IND\", \"United States\": \"USA\", \"United Kingdom\": \"GBR\", \"Canada\": \"CAN\", \"Germany\": \"DEU\", \"France\": \"FRA\", \"Brazil\": \"BRA\", \"Australia\": \"AUS\", \"Japan\": \"JPN\", \"South Africa\": \"ZAF\"}\n",
    "    df_map[\"ISO_Code\"] = df_map[\"Country\"].map(iso)\n",
    "    map_fig = px.choropleth(df_map, locations=\"ISO_Code\", color=\"Installs\", animation_frame=\"Category\", \n",
    "                            template=\"plotly_dark\", color_continuous_scale=\"Viridis\")\n",
    "    map_fig.update_layout(paper_bgcolor='rgba(0,0,0,0)', margin=dict(t=0, b=0, l=0, r=0))\n",
    "    return map_fig\n",
    "\n",
    "def run_t4():\n",
    "    if not (2 <= current_time_obj.hour < 20): return None\n",
    "    df = Apps_Df.copy()\n",
    "    df = df[(df['Rating'] >= 4.2) & (df['Category'].str.startswith(('T', 'P'))) & (df['Reviews'] > 1000)]\n",
    "    df['Month'] = df['Last Updated'].dt.to_period('M').astype(str)\n",
    "    p_df = df.groupby(['Month', 'Category'])['Installs'].sum().reset_index().pivot(index='Month', columns='Category', values='Installs').fillna(0).cumsum()\n",
    "    fig, ax = plt.subplots(figsize=(12, 7), facecolor='#111111')\n",
    "    ax.set_facecolor('#111111')\n",
    "    p_df.plot(kind=\"area\", stacked=True, ax=ax, alpha=0.8)\n",
    "    h, l = ax.get_legend_handles_labels()\n",
    "    trans = {\"TRAVEL_AND_LOCAL\": \"Voyage et Local\", \"PRODUCTIVITY\": \"Productividad\", \"PHOTOGRAPHY\": \"å†™çœŸ\"}\n",
    "    ax.legend(h, [trans.get(label, label) for label in l], facecolor=\"#111111\", labelcolor='white', frameon=False, prop={'weight': 'bold'})\n",
    "    ax.tick_params(colors='white')\n",
    "    ax.yaxis.set_major_formatter(mtick.FuncFormatter(lambda x, _: f\"{x/1e9:.1f}B\"))\n",
    "    return fig\n",
    "\n",
    "def run_t5():\n",
    "    if not (2 <= current_time_obj.hour < 20): return None\n",
    "    data = {'App': ['War Zone', 'Makeup Kit', 'Work Hub', 'Love Chat', 'Photo Lab', 'Connect', 'Grid Play'],\n",
    "            'Category': ['Game', 'Beauty', 'Business', 'Dating', 'Entertainment', 'Social', 'Game'],\n",
    "            'Rating': [4.5, 4.2, 4.0, 3.8, 4.4, 4.0, 4.8],\n",
    "            'Size_MB': [45, 20, 15, 30, 50, 35, 60],\n",
    "            'Installs': [1000000, 200000, 100000, 500000, 300000, 900000, 5000000]}\n",
    "    df = pd.DataFrame(data)\n",
    "    df = df[~df['App'].str.contains(r's', case=False, regex=True)]\n",
    "    trans_map = {'Beauty': 'à¤¸à¥Œà¤‚à¤¦à¤°à¥à¤¯ (Hindi)', 'Business': 'à®µà®£à®¿à®•à®®à¯ (Tamil)', 'Game': 'Game'}\n",
    "    df['Category'] = df['Category'].map(lambda x: trans_map.get(x, x))\n",
    "    fig, ax = plt.subplots(figsize=(12, 8), facecolor='#111111')\n",
    "    ax.set_facecolor('#111111')\n",
    "    for cat in df['Category'].unique():\n",
    "        sub = df[df['Category'] == cat]\n",
    "        ax.scatter(sub['Size_MB'], sub['Rating'], s=(sub['Installs']/500)+500, alpha=0.6, edgecolors='white', label=cat)\n",
    "    ax.legend(loc='upper left', facecolor='#111111', labelcolor='white', frameon=False, prop={'weight': 'bold'})\n",
    "    ax.tick_params(colors='white')\n",
    "    return fig\n",
    "\n",
    "def run_t6():\n",
    "    if not (time(2, 0) <= current_time_obj.time() <= time(20, 0)): return None\n",
    "    df = Apps_Df.copy()\n",
    "    df = df[(df['Reviews'] > 500) & (~df['App'].str.contains('s', case=False)) & (df['Category'].str.startswith(('E', 'C', 'B')))]\n",
    "    t6_trans = {'BEAUTY': 'à¤¸à¥Œà¤‚à¤¦à¤°à¥à¤¯ (Hindi)', 'BUSINESS': 'à®µà®£à®¿à®•à®®à¯ (Tamil)'}\n",
    "    df['Category'] = df['Category'].map(lambda x: t6_trans.get(x, x))\n",
    "    df['Month'] = df['Last Updated'].dt.to_period('M').dt.to_timestamp()\n",
    "    monthly = df.groupby(['Month', 'Category'])['Installs'].sum().reset_index()\n",
    "    fig, ax = plt.subplots(figsize=(10, 7), facecolor='#111111')\n",
    "    ax.set_facecolor('#111111')\n",
    "    colors = ['#00FFFF', '#8F00FF', '#FF69B4']\n",
    "    for idx, cat in enumerate(monthly['Category'].unique()):\n",
    "        data = monthly[monthly['Category'] == cat]\n",
    "        ax.plot(data['Month'], data['Installs'], marker='o', color=colors[idx % 3], label=cat)\n",
    "    ax.set_yscale('log')\n",
    "    ax.legend(facecolor='#111111', labelcolor='white', frameon=False, prop={'weight': 'bold'})\n",
    "    ax.tick_params(colors='white')\n",
    "    return fig\n",
    "\n",
    "# --- FINAL DASHBOARD LAYOUT CONFIG ---\n",
    "task_sections = [\n",
    "    {\n",
    "        \"banner\": \"TASK 1 : Category-wise Comparison of Average Rating and Reviews for Top Installed Apps\",\n",
    "        \"charts\": {\n",
    "            \"User Engagement\": (fig1, True),\n",
    "            \"Market Distribution\": (PIE_CHART, True),\n",
    "            \"Rating Frequency\": (HISTOGRAM, True, True)\n",
    "        }\n",
    "    },\n",
    "    {\n",
    "        \"banner\": \"Task 2: Free vs Paid Apps\",\n",
    "        \"charts\": {\"Performance Metrics\": (fig_to_base64(run_t2()), False, True)}\n",
    "    },\n",
    "    {\n",
    "        \"banner\": \"Task 3: Global Install Distribution by App Category\",\n",
    "        \"charts\": {\"Map View\": (run_t3(), True, True)}\n",
    "    },\n",
    "    {\n",
    "        \"banner\": \"Task 4: Cumulative Installs Trend by Category Using Stacked Area Chart\",\n",
    "        \"charts\": {\"Growth Trend\": (fig_to_base64(run_t4()), False, True)}\n",
    "    },\n",
    "    {\n",
    "        \"banner\": \"Task 5: App Size vs Rating Analysis Using Bubble Chart\",\n",
    "        \"charts\": {\"Size vs Rating\": (fig_to_base64(run_t5()), False, True)}\n",
    "    },\n",
    "    {\n",
    "        \"banner\": \"Task 6: Category-Based Install Growth Trend Over Time with Significant Growth Highlighting\",\n",
    "        \"charts\": {\"Growth Trajectory\": (fig_to_base64(run_t6()), False, True)}\n",
    "    }\n",
    "]\n",
    "\n",
    "def render_chart(title, content_tuple):\n",
    "    content, is_plotly = content_tuple[0], content_tuple[1]\n",
    "    is_special = len(content_tuple) > 2\n",
    "    centered_card = \"centered-card\" if is_special else \"\"\n",
    "    \n",
    "    if content is None:\n",
    "        inner = '<div class=\"time-lock\"><span>ðŸ”’</span><br>Available 02:00 - 12:00 IST</div>'\n",
    "    elif is_plotly:\n",
    "        inner = pio.to_html(content, full_html=False, config={'displayModeBar': False})\n",
    "    else:\n",
    "        inner = f'<img class=\"chart-img\" src=\"data:image/png;base64,{content}\">'\n",
    "    return f'<div class=\"card {centered_card}\"><div class=\"card-header\">{title.upper()}</div><div class=\"chart-content\">{inner}</div></div>'\n",
    "\n",
    "content_html = \"\"\n",
    "for section in task_sections:\n",
    "    content_html += f'<div class=\"section-banner\">{section[\"banner\"]}</div>'\n",
    "    for k, v in section[\"charts\"].items():\n",
    "        content_html += render_chart(k, v)\n",
    "\n",
    "html_dashboard = f\"\"\"\n",
    "<!DOCTYPE html><html><head><meta charset=\"UTF-8\">\n",
    "<style>\n",
    "    :root {{ --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; }}\n",
    "    body {{ background: var(--bg); color: var(--text); font-family: 'Nirmala UI', 'Segoe UI', 'MS Gothic', sans-serif; margin: 0; padding: 40px; }}\n",
    "    header {{ display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto 40px auto; border-bottom: 2px solid var(--accent); padding-bottom: 20px; }}\n",
    "    .section-banner {{ grid-column: span 2; background: #0ea5e9; color: white; padding: 15px; border-radius: 8px; font-weight: bold; text-align: center; margin-top: 30px; font-size: 1.2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }}\n",
    "    .google-wordmark {{ height: 45px; }} .play-icon {{ height: 50px; }}\n",
    "    .title-group {{ text-align: center; flex-grow: 1; }}\n",
    "    h1 {{ margin: 0; font-size: 2.1rem; text-transform: uppercase; }}\n",
    "    .grid {{ display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; max-width: 1400px; margin: auto; }}\n",
    "    .card {{ background: var(--card); border-radius: 16px; border: 1px solid #334155; overflow: hidden; }}\n",
    "    .centered-card {{ width: calc(50% - 12.5px); grid-column: span 2; margin: 0 auto; }}\n",
    "    .card-header {{ background: rgba(0,0,0,0.2); padding: 15px 20px; font-weight: 700; color: var(--accent); border-bottom: 1px solid #334155; }}\n",
    "    .chart-content {{ padding: 10px; min-height: 350px; display: flex; align-items: center; justify-content: center; }}\n",
    "    img.chart-img {{ width: 100%; border-radius: 8px; }}\n",
    "</style>\n",
    "</head><body>\n",
    "    <header>\n",
    "        <img class=\"google-wordmark\" src=\"https://upload.wikimedia.org/wikipedia/commons/2/2f/Google_2015_logo.svg\">\n",
    "        <div class=\"title-group\">\n",
    "            <h1>Google Playstore Analytics Review Dashboard</h1>\n",
    "            <p style=\"color: #64748b; margin-top: 10px;\">Sync: {current_time_obj.strftime('%Y-%m-%d %H:%M')} IST</p>\n",
    "        </div>\n",
    "        <img class=\"play-icon\" src=\"https://upload.wikimedia.org/wikipedia/commons/d/d0/Google_Play_Arrow_logo.svg\">\n",
    "    </header>\n",
    "    <div class=\"grid\">\n",
    "        {content_html}\n",
    "    </div>\n",
    "</body></html>\n",
    "\"\"\"\n",
    "\n",
    "with open(\"pro_dashboard.html\", \"w\", encoding=\"utf-8\") as f: f.write(html_dashboard)\n",
    "webbrowser.open('file://' + os.path.abspath(\"pro_dashboard.html\"))\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d2ab0233-dace-4c8b-8a7e-5fecc25c926e",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
